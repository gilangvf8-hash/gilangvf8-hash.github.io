---
layout: default
title: Download Video
---

<h2>Download Video</h2>
<div id="result">Sedang memproses...</div>

<script>
const params = new URLSearchParams(window.location.search);
const videoId = params.get("id");

async function fetchDownloadLink(videoId) {
  try {
    // Panggil proxy API kamu sendiri
    const response = await fetch(`/api/download?id=${videoId}`);
    const run = await response.json();

    if (!run.data) {
      document.getElementById("result").innerHTML = "<p>Gagal memulai proses.</p>";
      return;
    }

    const runId = run.data.id;
    document.getElementById("result").innerHTML = `<p>Menunggu hasil dari server...</p>`;

    // Tunggu sampai status SUCCEEDED
    let finished = false;
    while (!finished) {
      const res = await fetch(`/api/runStatus?id=${runId}`);
      const data = await res.json();

      if (data.data.status === "SUCCEEDED") {
        finished = true;
        const items = data.data.output?.items;
        if (items && items.length > 0 && items[0].downloadUrl) {
          document.getElementById("result").innerHTML = `
            <p><b>Judul:</b> ${items[0].title}</p>
            <a href="${items[0].downloadUrl}" target="_blank">⬇️ Download Video</a>
          `;
        } else {
          document.getElementById("result").innerHTML = "<p>Gagal mendapatkan link unduhan.</p>";
        }
      } else if (data.data.status === "FAILED") {
        finished = true;
        document.getElementById("result").innerHTML = "<p>Proses gagal.</p>";
      } else {
        await new Promise(r => setTimeout(r, 2000)); // cek lagi setelah 2 detik
      }
    }
  } catch (err) {
    document.getElementById("result").innerHTML = "<p>Error: " + err + "</p>";
  }
}

if (videoId) {
  fetchDownloadLink(videoId);
} else {
  document.getElementById("result").innerHTML = "<p>ID video tidak ditemukan.</p>";
}
</script>